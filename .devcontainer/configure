#!/bin/bash

pip install PyYAML kubernetes
bash install-cilium-cli
helm plugin install https://github.com/databus23/helm-diff

# Not sure why but when I rebuild the devcontainer
# the old kind cluster still exists although it's a new
# container. Lets delete it always so we start with a fresh
# Kubernetes cluster.
kind delete cluster --name kubernetes-base-cluster &> /dev/null

mkdir -p ~/.kube && kind create cluster --config=kind-kubernetes-base-cluster.yaml

wget https://github.com/dylode/gotemplate-cli/releases/download/v.0.1.0/gotcli
sudo chmod +x gotcli
sudo mv gotcli /usr/local/bin/

gotcli render -j "$(docker network inspect kind)" "$(cat /workspaces/kubernetes-base/frr/frr.conf.gotemplate)" > /workspaces/kubernetes-base/frr/frr.conf

docker compose -f /workspaces/kubernetes-base/docker-compose.yaml up -d